var P=Object.defineProperty;var O=(d,e,r)=>e in d?P(d,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):d[e]=r;var l=(d,e,r)=>O(d,typeof e!="symbol"?e+"":e,r);import{b as S}from"./buffer-DWQSt5K4.js";import{g as C}from"./@babel-D6-XlEtG.js";var x={exports:{}},E;function A(){return E||(E=1,function(d){var e=Object.prototype.hasOwnProperty,r="~";function t(){}Object.create&&(t.prototype=Object.create(null),new t().__proto__||(r=!1));function c(u,n,s){this.fn=u,this.context=n,this.once=s||!1}function _(u,n,s,o,y){if(typeof s!="function")throw new TypeError("The listener must be a function");var p=new c(s,o||u,y),a=r?r+n:n;return u._events[a]?u._events[a].fn?u._events[a]=[u._events[a],p]:u._events[a].push(p):(u._events[a]=p,u._eventsCount++),u}function v(u,n){--u._eventsCount===0?u._events=new t:delete u._events[n]}function h(){this._events=new t,this._eventsCount=0}h.prototype.eventNames=function(){var n=[],s,o;if(this._eventsCount===0)return n;for(o in s=this._events)e.call(s,o)&&n.push(r?o.slice(1):o);return Object.getOwnPropertySymbols?n.concat(Object.getOwnPropertySymbols(s)):n},h.prototype.listeners=function(n){var s=r?r+n:n,o=this._events[s];if(!o)return[];if(o.fn)return[o.fn];for(var y=0,p=o.length,a=new Array(p);y<p;y++)a[y]=o[y].fn;return a},h.prototype.listenerCount=function(n){var s=r?r+n:n,o=this._events[s];return o?o.fn?1:o.length:0},h.prototype.emit=function(n,s,o,y,p,a){var m=r?r+n:n;if(!this._events[m])return!1;var i=this._events[m],k=arguments.length,w,f;if(i.fn){switch(i.once&&this.removeListener(n,i.fn,void 0,!0),k){case 1:return i.fn.call(i.context),!0;case 2:return i.fn.call(i.context,s),!0;case 3:return i.fn.call(i.context,s,o),!0;case 4:return i.fn.call(i.context,s,o,y),!0;case 5:return i.fn.call(i.context,s,o,y,p),!0;case 6:return i.fn.call(i.context,s,o,y,p,a),!0}for(f=1,w=new Array(k-1);f<k;f++)w[f-1]=arguments[f];i.fn.apply(i.context,w)}else{var L=i.length,b;for(f=0;f<L;f++)switch(i[f].once&&this.removeListener(n,i[f].fn,void 0,!0),k){case 1:i[f].fn.call(i[f].context);break;case 2:i[f].fn.call(i[f].context,s);break;case 3:i[f].fn.call(i[f].context,s,o);break;case 4:i[f].fn.call(i[f].context,s,o,y);break;default:if(!w)for(b=1,w=new Array(k-1);b<k;b++)w[b-1]=arguments[b];i[f].fn.apply(i[f].context,w)}}return!0},h.prototype.on=function(n,s,o){return _(this,n,s,o,!1)},h.prototype.once=function(n,s,o){return _(this,n,s,o,!0)},h.prototype.removeListener=function(n,s,o,y){var p=r?r+n:n;if(!this._events[p])return this;if(!s)return v(this,p),this;var a=this._events[p];if(a.fn)a.fn===s&&(!y||a.once)&&(!o||a.context===o)&&v(this,p);else{for(var m=0,i=[],k=a.length;m<k;m++)(a[m].fn!==s||y&&!a[m].once||o&&a[m].context!==o)&&i.push(a[m]);i.length?this._events[p]=i.length===1?i[0]:i:v(this,p)}return this},h.prototype.removeAllListeners=function(n){var s;return n?(s=r?r+n:n,this._events[s]&&v(this,s)):(this._events=new t,this._eventsCount=0),this},h.prototype.off=h.prototype.removeListener,h.prototype.addListener=h.prototype.on,h.prefixed=r,h.EventEmitter=h,d.exports=h}(x)),x.exports}var T=A();const q=C(T);var F=class extends q{constructor(e,r,t){super();l(this,"socket");this.socket=new window.WebSocket(e,t),this.socket.onopen=()=>this.emit("open"),this.socket.onmessage=c=>this.emit("message",c.data),this.socket.onerror=c=>this.emit("error",c),this.socket.onclose=c=>{this.emit("close",c.code,c.reason)}}send(e,r,t){const c=t||r;try{this.socket.send(e),c()}catch(_){c(_)}}close(e,r){this.socket.close(e,r)}addEventListener(e,r,t){this.socket.addEventListener(e,r,t)}};function j(d,e){return new F(d,e)}var g=class{encode(d){return JSON.stringify(d)}decode(d){return JSON.parse(d)}},B=class extends q{constructor(e,r="ws://localhost:8080",{autoconnect:t=!0,reconnect:c=!0,reconnect_interval:_=1e3,max_reconnects:v=5,...h}={},u,n){super();l(this,"address");l(this,"rpc_id");l(this,"queue");l(this,"options");l(this,"autoconnect");l(this,"ready");l(this,"reconnect");l(this,"reconnect_timer_id");l(this,"reconnect_interval");l(this,"max_reconnects");l(this,"rest_options");l(this,"current_reconnects");l(this,"generate_request_id");l(this,"socket");l(this,"webSocketFactory");l(this,"dataPack");this.webSocketFactory=e,this.queue={},this.rpc_id=0,this.address=r,this.autoconnect=t,this.ready=!1,this.reconnect=c,this.reconnect_timer_id=void 0,this.reconnect_interval=_,this.max_reconnects=v,this.rest_options=h,this.current_reconnects=0,this.generate_request_id=u||(()=>typeof this.rpc_id=="number"?++this.rpc_id:Number(this.rpc_id)+1),n?this.dataPack=n:this.dataPack=new g,this.autoconnect&&this._connect(this.address,{autoconnect:this.autoconnect,reconnect:this.reconnect,reconnect_interval:this.reconnect_interval,max_reconnects:this.max_reconnects,...this.rest_options})}connect(){this.socket||this._connect(this.address,{autoconnect:this.autoconnect,reconnect:this.reconnect,reconnect_interval:this.reconnect_interval,max_reconnects:this.max_reconnects,...this.rest_options})}call(e,r,t,c){return!c&&typeof t=="object"&&(c=t,t=null),new Promise((_,v)=>{if(!this.ready)return v(new Error("socket not ready"));const h=this.generate_request_id(e,r),u={jsonrpc:"2.0",method:e,params:r||void 0,id:h};this.socket.send(this.dataPack.encode(u),c,n=>{if(n)return v(n);this.queue[h]={promise:[_,v]},t&&(this.queue[h].timeout=setTimeout(()=>{delete this.queue[h],v(new Error("reply timeout"))},t))})})}async login(e){const r=await this.call("rpc.login",e);if(!r)throw new Error("authentication failed");return r}async listMethods(){return await this.call("__listMethods")}notify(e,r){return new Promise((t,c)=>{if(!this.ready)return c(new Error("socket not ready"));const _={jsonrpc:"2.0",method:e,params:r};this.socket.send(this.dataPack.encode(_),v=>{if(v)return c(v);t()})})}async subscribe(e){typeof e=="string"&&(e=[e]);const r=await this.call("rpc.on",e);if(typeof e=="string"&&r[e]!=="ok")throw new Error("Failed subscribing to an event '"+e+"' with: "+r[e]);return r}async unsubscribe(e){typeof e=="string"&&(e=[e]);const r=await this.call("rpc.off",e);if(typeof e=="string"&&r[e]!=="ok")throw new Error("Failed unsubscribing from an event with: "+r);return r}close(e,r){this.socket.close(e||1e3,r)}setAutoReconnect(e){this.reconnect=e}setReconnectInterval(e){this.reconnect_interval=e}setMaxReconnects(e){this.max_reconnects=e}_connect(e,r){clearTimeout(this.reconnect_timer_id),this.socket=this.webSocketFactory(e,r),this.socket.addEventListener("open",()=>{this.ready=!0,this.emit("open"),this.current_reconnects=0}),this.socket.addEventListener("message",({data:t})=>{t instanceof ArrayBuffer&&(t=S.Buffer.from(t).toString());try{t=this.dataPack.decode(t)}catch{return}if(t.notification&&this.listeners(t.notification).length){if(!Object.keys(t.params).length)return this.emit(t.notification);const c=[t.notification];if(t.params.constructor===Object)c.push(t.params);else for(let _=0;_<t.params.length;_++)c.push(t.params[_]);return Promise.resolve().then(()=>{this.emit.apply(this,c)})}if(!this.queue[t.id])return t.method?Promise.resolve().then(()=>{this.emit(t.method,t==null?void 0:t.params)}):void 0;"error"in t=="result"in t&&this.queue[t.id].promise[1](new Error('Server response malformed. Response must include either "result" or "error", but not both.')),this.queue[t.id].timeout&&clearTimeout(this.queue[t.id].timeout),t.error?this.queue[t.id].promise[1](t.error):this.queue[t.id].promise[0](t.result),delete this.queue[t.id]}),this.socket.addEventListener("error",t=>this.emit("error",t)),this.socket.addEventListener("close",({code:t,reason:c})=>{this.ready&&setTimeout(()=>this.emit("close",t,c),0),this.ready=!1,this.socket=void 0,t!==1e3&&(this.current_reconnects++,this.reconnect&&(this.max_reconnects>this.current_reconnects||this.max_reconnects===0)&&(this.reconnect_timer_id=setTimeout(()=>this._connect(e,r),this.reconnect_interval)))})}};export{B as C,j as W};
